---
alwaysApply: true
---

# Test User Login

email: test@test.com
password: 3fjgir987340gjghgrr

# Clerk Integration

This project uses [Clerk](https://clerk.com) for authentication and user management.

### Setup and Configuration

#### Environment Variables

Authentication configuration is managed in [src/env.mjs](mdc:src/env.mjs):

- `CLERK_SECRET_KEY` - Server-side secret key
- `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` - Client-side publishable key
- `NEXT_PUBLIC_CLERK_SIGN_IN_URL` - Sign-in page URL
- `NEXT_PUBLIC_CLERK_SIGN_UP_URL` - Sign-up page URL
- `WEBHOOK_SECRET` - For Clerk webhooks

#### Root Layout Provider

The `ClerkProvider` is configured in [src/app/layout.tsx](mdc:src/app/layout.tsx):

```typescript
import { ClerkProvider } from '@clerk/nextjs'

const RootLayout: React.FC<RootLayoutProps> = ({ children }) => {
  return (
    <ClerkProvider>
      <html lang="en" suppressHydrationWarning>
        <body className={cn('mx-auto min-h-screen antialiased')}>
          {children}
        </body>
      </html>
    </ClerkProvider>
  )
}
```

### Middleware Protection

Protected routes are defined in [src/middleware.ts](mdc:src/middleware.ts):

```typescript
import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server'

const isProtectedRoute = createRouteMatcher(['/dashboard(.*)'])

export default clerkMiddleware(async (auth, req) => {
  if (isProtectedRoute(req)) await auth.protect()
})
```

### Authentication Routes

#### Sign-in/Sign-up Pages

- Sign-in: `src/app/sign-in/[[...sign-in]]/page.tsx`
- Sign-up: `src/app/sign-up/[[...sign-up]]/page.tsx`

Use Clerk's built-in components:

```typescript
import { SignIn, SignUp } from '@clerk/nextjs'

export default function SignInPage() {
  return <SignIn />
}
```

### User Data Management

#### Database User Model

User data is stored in PostgreSQL via Prisma schema [prisma/schema.prisma](mdc:prisma/schema.prisma):

```prisma
model User {
  id        Int         @id @default(autoincrement())
  clerkId   String      @unique
  email     String?     @unique
  name      String?
  bio       String?
  categories Category[]
  completed Completed[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}
```

#### User Synchronization

Handle user creation/updates through Clerk webhooks in [src/app/api/webhooks/route.ts](mdc:src/app/api/webhooks/route.ts).

### Authentication Hooks and Utilities

#### Client-Side Authentication

```typescript
import { useUser, useAuth, useClerk } from '@clerk/nextjs'

// Get current user information
const { user, isLoaded, isSignedIn } = useUser()

// Get authentication state
const { userId, sessionId, getToken } = useAuth()

// Get Clerk instance for sign out
const { signOut } = useClerk()
```

#### Server-Side Authentication

```typescript
import { auth } from '@clerk/nextjs/server'

// In API routes or server components
export async function GET() {
  const { userId } = await auth()

  if (!userId) {
    return new Response('Unauthorized', { status: 401 })
  }

  // Handle authenticated request
}
```

### Component Patterns

#### Protected Components

```typescript
import { auth } from '@clerk/nextjs/server'
import { redirect } from 'next/navigation'

export default async function ProtectedPage() {
  const { userId } = await auth()

  if (!userId) {
    redirect('/sign-in')
  }

  // Render protected content
}
```

#### Sign Out Component

Example from [src/components/SignoutButton.tsx](mdc:src/components/SignoutButton.tsx):

```typescript
'use client'

import { useClerk } from '@clerk/nextjs'

const SignOutButton: React.FC<SignOutButtonProps> = ({ className }) => {
  const { signOut } = useClerk()

  return (
    <button
      onClick={() => signOut()}
      className={cn('sign-out-button-styles', className)}
    >
      Sign Out
    </button>
  )
}
```

## Security Best Practices

### Route Protection

- Use `clerkMiddleware` for route-level protection
- Implement server-side auth checks in API routes
- Validate user permissions for sensitive operations

### Data Access Control

- Always verify user ownership of resources
- Use Clerk's `userId` for database queries
- Implement proper authorization checks

### Environment Security

- Never expose secret keys in client-side code
- Use server-side environment variables for sensitive data
- Validate webhook signatures for security

### Session Management

- Clerk handles session management automatically
- Use `getToken()` for API authentication
- Implement proper token validation in API routes

## Clerk MCP Tools

This project integrates **Clerk MCP Server** for programmatic user and organization management. The following MCP tools are available for AI assistants:

### User Management Tools

#### `getUserId`
Get the userId of the current authenticated user. Returns `null` if not signed in.

```typescript
// Example usage in AI context
const userId = await mcp_clerk_getUserId()
```

#### `getUser`
Retrieve detailed user information by userId. If no userId is provided, returns current authenticated user.

```typescript
// Get specific user
const user = await mcp_clerk_getUser({ userId: 'user_xxx' })

// Get current user
const currentUser = await mcp_clerk_getUser({ userId: await mcp_clerk_getUserId() })
```

**Returns:**
- `id`, `clerkId`, `email`, `username`, `firstName`, `lastName`
- `profileImageUrl`, `createdAt`, `updatedAt`
- `publicMetadata`, `privateMetadata`, `unsafeMetadata`

#### `getUserCount`
Get the total count of users in the Clerk instance.

```typescript
const count = await mcp_clerk_getUserCount()
```

#### `updateUser`
Update user core attributes (NOT metadata). Only provided fields are updated.

```typescript
await mcp_clerk_updateUser({
  userId: 'user_xxx',
  firstName: 'John',
  lastName: 'Doe',
  username: 'johndoe',
  profileImageUrl: 'https://example.com/avatar.jpg'
})
```

#### `updateUserPublicMetadata`
Update user public metadata (visible to frontend). Performs deep merge.

```typescript
await mcp_clerk_updateUserPublicMetadata({
  userId: 'user_xxx',
  metadata: {
    preferences: { theme: 'dark' },
    onboarded: true
  }
})

// Remove keys by setting to null
await mcp_clerk_updateUserPublicMetadata({
  userId: 'user_xxx',
  metadata: { preferences: null }
})
```

#### `updateUserUnsafeMetadata`
Update user unsafe metadata (accessible from both frontend and backend, but NOT in JWT).

```typescript
await mcp_clerk_updateUserUnsafeMetadata({
  userId: 'user_xxx',
  metadata: {
    lastViewedPage: '/dashboard',
    temporarySettings: { flag: true }
  }
})
```

### Organization Management Tools

#### `getOrganization`
Retrieve organization details by ID or slug.

```typescript
const org = await mcp_clerk_getOrganization({
  organizationId: 'org_xxx',
  includeMembersCount: true
})

// Or by slug
const org = await mcp_clerk_getOrganization({
  slug: 'my-org',
  includeMembersCount: true
})
```

#### `createOrganization`
Create a new organization.

```typescript
const newOrg = await mcp_clerk_createOrganization({
  name: 'My Organization',
  slug: 'my-org', // Optional, auto-generated from name if not provided
  createdBy: 'user_xxx', // Optional, defaults to current user
  maxAllowedMemberships: 50, // Optional
  publicMetadata: { industry: 'tech' }, // Optional
  privateMetadata: { internalId: '12345' } // Optional
})
```

#### `updateOrganization`
Update organization attributes.

```typescript
await mcp_clerk_updateOrganization({
  organizationId: 'org_xxx',
  name: 'Updated Name',
  maxAllowedMemberships: 100,
  publicMetadata: { industry: 'fintech' }
})
```

#### `updateOrganizationMetadata`
Update organization metadata with deep merge.

```typescript
await mcp_clerk_updateOrganizationMetadata({
  organizationId: 'org_xxx',
  publicMetadata: { settings: { feature: true } },
  privateMetadata: { secret: 'value' }
})
```

### Organization Membership Tools

#### `createOrganizationMembership`
Add a user to an organization with specified role.

```typescript
await mcp_clerk_createOrganizationMembership({
  organizationId: 'org_xxx',
  userId: 'user_xxx',
  role: 'org:member' // or 'org:admin'
})
```

#### `updateOrganizationMembership`
Update a user's role within an organization.

```typescript
await mcp_clerk_updateOrganizationMembership({
  organizationId: 'org_xxx',
  userId: 'user_xxx',
  role: 'org:admin'
})
```

#### `updateOrganizationMembershipMetadata`
Update membership-specific metadata.

```typescript
await mcp_clerk_updateOrganizationMembershipMetadata({
  organizationId: 'org_xxx',
  userId: 'user_xxx',
  publicMetadata: { department: 'Engineering' },
  privateMetadata: { startDate: '2025-01-01' }
})
```

#### `deleteOrganizationMembership`
Remove a user from an organization.

```typescript
await mcp_clerk_deleteOrganizationMembership({
  organizationId: 'org_xxx',
  userId: 'user_xxx'
})
```

### Invitation Tools

#### `createOrganizationInvitation`
Invite a user to join an organization.

```typescript
await mcp_clerk_createOrganizationInvitation({
  organizationId: 'org_xxx',
  emailAddress: 'newmember@example.com',
  role: 'org:member',
  inviterUserId: 'user_xxx', // Optional, defaults to current user
  redirectUrl: 'https://app.example.com/onboard', // Optional
  publicMetadata: { source: 'admin_panel' } // Optional
})
```

#### `revokeOrganizationInvitation`
Revoke a pending organization invitation.

```typescript
await mcp_clerk_revokeOrganizationInvitation({
  organizationId: 'org_xxx',
  invitationId: 'inv_xxx',
  requestingUserId: 'user_xxx' // Optional, defaults to current user
})
```

#### `createInvitation`
Create a general application invitation (not organization-specific).

```typescript
await mcp_clerk_createInvitation({
  emailAddress: 'newuser@example.com',
  redirectUrl: 'https://app.example.com/welcome', // Optional
  publicMetadata: { referral: 'campaign_xyz' }, // Optional
  notify: true, // Optional, defaults to true
  ignoreExisting: false // Optional, defaults to false
})
```

#### `revokeInvitation`
Revoke a pending application invitation.

```typescript
await mcp_clerk_revokeInvitation({
  invitationId: 'inv_xxx'
})
```

### MCP Tools Usage Guidelines

1. **User Verification:** Use `getUserId()` or `getUser()` to verify test user existence before debugging auth issues.
2. **Metadata vs Core Attributes:** Use dedicated metadata update tools for custom data; use `updateUser` only for core Clerk fields.
3. **Deep Merge:** All metadata update operations perform deep mergeâ€”set values to `null` to remove keys.
4. **Organization Roles:** Common roles are `org:admin`, `org:member`. Custom roles can be defined in Clerk Dashboard.
5. **Testing:** Leverage these tools for E2E test setup, user/org creation, and state verification.

## Error Handling

### Authentication Errors

```typescript
try {
  const { userId } = await auth()
  if (!userId) throw new Error('Unauthorized')
} catch (error) {
  // Log authentication error
  console.error('Authentication failed:', error)
  return new Response('Authentication required', { status: 401 })
}
```

### User Data Errors

```typescript
try {
  const user = await prisma.user.findUnique({
    where: { clerkId: userId }
  })
  if (!user) throw new Error('User not found')
} catch (error) {
  // Handle user data errors
  console.error('User data error:', error)
  return new Response('User not found', { status: 404 })
}
```

## Login Testing

For detailed login testing procedures and browser automation guidelines, see [`.cursor/rules/login.mdc`](mdc:.cursor/rules/login.mdc).
