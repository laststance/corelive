services:
  postgres:
    image: postgres:17
    container_name: corelive-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: corelive
      POSTGRES_INITDB_ARGS: '--auth-host=scram-sha-256 --auth-local=scram-sha-256'
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./prisma/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'PGPASSWORD=password pg_isready -U postgres && PGPASSWORD=password psql -U postgres -lqt | cut -d \| -f 1 | grep -qw corelive',
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - corelive-network

  # Sidecar container to simulate production network latency (5 seconds delay)
  # Uses Linux Traffic Control (tc) with netem to add delay to PostgreSQL network
  network-delay:
    image: alpine:latest
    container_name: corelive-network-delay
    network_mode: 'service:postgres'
    cap_add:
      - NET_ADMIN
    depends_on:
      postgres:
        condition: service_healthy
    command: >
      sh -c "
        apk add --no-cache iproute2 &&
        tc qdisc add dev eth0 root netem delay 100ms &&
        echo 'âœ… Network delay of 100ms applied to PostgreSQL' &&
        sleep infinity
      "
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local

networks:
  corelive-network:
    driver: bridge
